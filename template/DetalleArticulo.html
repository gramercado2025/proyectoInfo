{% load static %}
{% load humanize %}

<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{post.titulo}}| Blog de Triskel Radio</title>

    <script src="https://unpkg.com/lucide@latest"></script>

    <link rel="stylesheet" href="{% static 'css/style_articulo.css' %}">

</head>

<body>

    <header class="header">
        <div class="container header__container">

            <a href="#" class="header__logo logo-with-icon">
                <img src="{% static 'imagenes/logo radio.jpg' %}" alt="Logo de Mi Blog"
                    onerror="this.onerror=null;this.src='https://placehold.co/60x60/f8f8f8/E53935?text=Logo';"
                    class="logo-image">
                Nuestro Blog
            </a>

            <nav class="header__nav">
                <a href="{% url 'home' %}">Inicio</a>
                <a href="{% url 'lista_categorias_general' %}">Categorías</a>
                <a href="{% url  'eventos' %}">Eventos</a>
                <a href="#">Contacto</a>
                <a href="{% url 'pautas' %}">Pautas de la Comunidad</a>
            </nav>

            <button class="header__search-button" aria-label="Buscar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-search">
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.3-4.3" />
                </svg>
            </button>

            <button class="header__menu-button" aria-label="Abrir menú">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="lucide lucide-menu">
                    <line x1="4" x2="20" y1="12" y2="12" />
                    <line x1="4" x2="20" y1="6" y2="6" />
                    <line x1="4" x2="20" y1="18" y2="18" />
                </svg>
            </button>
        </div>
    </header>

    <main class="container main-content">
        <div class="main-grid">
            <section class="article-section">

                <article class="post-detail__article">
                    
                    <h1 class="post-detail__title">{{ post.titulo }}</h1>
                    <span class="post-detail__category">Categoría: {{ post.categoria_post }}</span>

                    <div class="post-detail__meta">
                        <span class="post-detail__author-meta">
                            <i data-lucide="user" class="icon"></i>
                            {{ post.autor_post }}
                        </span>
                        <span class="post-detail__date-meta">
                            <i data-lucide="calendar" class="icon"></i>
                            {{ post.fecha_creacion|date:"d/m/Y" }}
                        </span>
                        <span class="post-detail__read-time-meta">
                            <i data-lucide="clock" class="icon"></i>
                            {{ post.fecha_creacion|naturaltime }}
                        </span>
                        <a href="#" data-action="open-comments" style="color:var(--primary-color);">
                            <i data-lucide="message-circle" class="icon"></i>
                            {{post.total_comentarios}} Comentarios
                        </a>
                    </div>

                    {% if post.imagen_post%}
                        <img src="{{post.imagen_post.url}}" alt="Imagen {{post.titulo}}"
                            class="post-detail__image"
                            onerror="this.onerror=null;this.src='https://placehold.co/300x200/4CAF50/white?text=SinImagen';">
                        {% endif %}
                        
                    <p class="post-detail__lead">
                        {{ post.resumen }}
                    </p>

                    <div class="post-detail__content">

                        {{ post.contenido|safe }}

                        <iframe style="border-radius:12px"
                            src=" {{ post.link_spotifylist}}"
                            width="100%" height="352" frameBorder="0" allowfullscreen=""
                            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                            loading="lazy">
                        </iframe>

                    </div>

                    <button data-action="open-comments" class="comments-panel__login-button"
                        style="width: auto; margin-top: 2rem;">
                        <i data-lucide="message-square"
                            style="width:1.2rem; height:1.2rem; margin-right:0.5rem; color:white;"></i>
                        Ver/Escribir Comentarios
                    </button>

                </article>

            </section>

            <aside class="sidebar">

                <div class="sidebar__widget">
                    <h3 class="widget__title">
                        <i data-lucide="radio" class="icon"></i>
                        Triskel Radio
                    </h3>
                    <p class="widget__text">
                        Somos la voz que acompaña tu día con la mejor selección musical y los contenidos más
                        interesantes.
                        Desde novedades discográficas hasta las historias detrás de tus artistas favoritos. ¡Sintoniza y
                        descubre!
                    </p>
                </div>

                <div class="sidebar__widget">
                    <h3 class="widget__title">
                        <i data-lucide="folder" class="icon"></i>
                        Categorías
                    </h3>
                    <ul class="widget__list">
                        <li><a href="#">Historia Musical</a> <span class="widget__count">2</span></li>
                        <li><a href="#">Lo mejor de </a> <span class="widget__count">1</span></li>
                        <li><a href="#">Novedades de la radio</a> <span class="widget__count">1</span></li>
                        <li><a href="#">Pop Argentino</a> <span class="widget__count">1</span></li>
                        <li><a href="#">Pop Internacional</a> <span class="widget__count">1</span></li>
                    </ul>
                </div>

                <div class="sidebar__widget">
                    <h3 class="widget__title">
                        <i data-lucide="trending-up" class="icon"></i>
                        Los más Populares!
                    </h3>
                    <ul class="widget__list">
                        <li>
                            <a href="#">El fenómeno Taylor Swift</a>
                            <span class="widget__count text-light">2.5k vistas</span>
                        </li>
                        <li>
                            <a href="#">Miranda! continúa escribiendo la historia</a>
                            <span class="widget__count text-light">1.8k vistas</span>
                        </li>
                        <li>
                            <a href="#">Depeche Mode: Los Maestros</a>
                            <span class="widget__count text-light">1.5k vistas</span>
                        </li>
                        <li>
                            <a href="#">Las 20 mejores bandas estadounidenses</a>
                            <span class="widget__count text-light">1.2k vistas</span>
                        </li>
                    </ul>
                </div>
                <!-- <div class="sidebar__widget">
                    <h3 class="widget__title">
                        <i data-lucide="tag" class="icon"></i>
                        Etiquetas
                    </h3>
                    <div class="widget__tags">
                        <a href="#" class="widget__tag">#Pop</a>
                        <a href="#" class="widget__tag">#Rock</a>
                        <a href="#" class="widget__tag">#Internacional</a>
                        <a href="#" class="widget__tag">#Argentina</a>
                        <a href="#" class="widget__tag">#Los 80´s</a>
                        <a href="#" class="widget__tag">#PopLatino</a>
                        <a href="#" class="widget__tag">#Festivales</a>
                    </div>
                </div> -->
            </aside>

        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer__grid">
                <div>
                    <h3 class="footer__logo-footer">Blog Radio Triskel</h3>
                    <p class="widget__text">Tu estación de radio en línea con la mejor mezcla de música y contenidos.
                    </p>
                </div>
                <div>
                    <h4 class="footer__section-title">Enlaces Rápidos</h4>
                    <ul class="footer__list">
                        <li><a href="{% url 'home' %}">Inicio</li>
                        <li><a href="{% url 'lista_categorias_general' %}">Categorías</a></li>
                        <li><a href="{% url  'eventos' %}">Eventos</a></li>
                        <li><a href="#">Contacto</a></li>
                        <li><a href="{% url 'pautas' %}">Pautas de la Comunidad</a></li>

                    </ul>
                </div>
                <div>
                    <h4 class="footer__section-title">Categorías</h4>
                    <ul class="footer__list">
                        <li><a href="#">Lo mejor de</a></li>
                        <li><a href="#">Lo nuevo de </a></li>
                        <li><a href="#">Grupos Icónicos</a></li>
                        <li><a href="#">Novedades de la radio</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="footer__section-title">Síguenos</h4>
                    <div class="footer__social">
                        <a href="#" aria-label="Facebook"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-facebook">
                                <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z" />
                            </svg></a>

                        <a href="#" aria-label="Instagram"><svg xmlns="http://www.w3.org/2000/svg" width="24"
                                height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-instagram">
                                <rect width="20" height="20" x="2" y="2" rx="5" ry="5" />
                                <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z" />
                                <line x1="17.5" x2="17.51" y1="6.5" y2="6.5" />
                            </svg></a>
                        <a href="#" aria-label="Email"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mail">
                                <rect width="20" height="16" x="2" y="4" rx="2" />
                                <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7" />
                            </svg></a>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer__copy">
            <p class="footer__copy-text">© 2025 Blog de Triskel Radio. Proyecto Final - Grupo 2 - Informatorio Etapa 2 -
                Todos los derechos reservados.</p>
        </div>
    </footer>


    <div class="comments-panel">
    <div class="comments-panel__header">
        <h4 class="comments-panel__title">
            <i data-lucide="message-square" style="margin-right:0.5rem;"></i>
            Comentarios ({{ comentarios.count }})
        </h4>
        <button class="comments-panel__close-button" aria-label="Cerrar panel">
            <i data-lucide="x"></i>
        </button>
    </div>

    {# --- FORMULARIO DE COMENTARIO --- #}
    {% if user.is_authenticated %}
        
        <form method="post" action="{% url 'detalle_articulo' pk=post.pk %}" class="comments-panel__form">
            {% csrf_token %} 
            
            
            {{ form_comentario.contenido_comentario }} 
            
            {% if form_comentario.contenido_comentario.errors %}
                <p class="comments-panel__error-message">{{ form_comentario.contenido_comentario.errors }}</p>
            {% endif %}
            
            {{ form_comentario.non_field_errors }} 
            
            <button type="submit" class="comments-panel__login-button"
                        style="width: 100%; margin-top: 2rem;">
                        <i data-lucide="message-square"
                            style="width:1.2rem; height:1.2rem; margin-right:0.5rem; color:white;"></i>
                Enviar Comentario
            </button>
        </form>
    
    {% else %}
        <p class="comments-panel__info">
            Inicia sesión para dejar un comentario. Recuerda revisar nuestras
            <a href="{% url 'pautas' %}">pautas de la comunidad</a>.
        </p>

        <a href="{% url 'blog_auth:login' %}?next={{ request.path }}" class="comments-panel__login-button">
            Inicia sesión para comentar
        </a>
    
    {% endif %}

    {# --- LISTA DE COMENTARIOS --- #}
    <div class="comments-panel__comment-list" id="contenedor-comentarios">
    {# El ID es lo que JavaScript necesita para saber dónde actualizar el contenido #}
    {% include 'partials/lista_comentarios_fragmento.html' %} 

        
        
        
    </div>
</div>

   <script>
    // Inicializa íconos de Lucide
    lucide.createIcons();

    // --- Lógica del Panel Lateral de Comentarios ---
    const commentsPanel = document.querySelector('.comments-panel');
    const openButtons = document.querySelectorAll('[data-action="open-comments"]');
    const closeButton = document.querySelector('.comments-panel__close-button');


    function openCommentsPanel(event) {
        if (event) {
            event.preventDefault(); // Previene la navegación si fuera un enlace
        }
        commentsPanel.classList.add('comments-panel--open');
    }

    function closeCommentsPanel() {
        commentsPanel.classList.remove('comments-panel--open');
    }

    // Asignar listener a todos los botones de comentarios para abrir el panel
    openButtons.forEach(button => {
        button.addEventListener('click', openCommentsPanel);
    });

    // Asignar listener al botón de cierre
    closeButton.addEventListener('click', closeCommentsPanel);

    // Opcional: Cerrar al presionar la tecla ESC
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && commentsPanel.classList.contains('comments-panel--open')) {
            closeCommentsPanel();
        }
    });

    // --- LÓGICA AJAX PARA ORDENAMIENTO Y FILTRADO ---
    document.addEventListener('DOMContentLoaded', function() {
        // --- Variables de AJAX ---
        const contenedor = document.getElementById('contenedor-comentarios');
        const postPk = '{{ post.pk }}';

        // 1. Función principal para cargar los comentarios vía AJAX (Actualiza el contenido)
        function cargarComentarios(params = {}) {
            // Construye la URL para la vista AJAX
            const url = `/articulo/${postPk}/comentarios-ajax/?${new URLSearchParams(params).toString()}`;
            
            // Indicador de carga temporal
            contenedor.innerHTML = '<p class="text-center p-3">Cargando comentarios...</p>';
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    return response.text(); 
                })
                .then(html => {
                    // Reemplaza el contenido del contenedor con el nuevo HTML
                    contenedor.innerHTML = html; 
                    // CRUCIAL: Vuelve a adjuntar los eventos a los botones nuevos
                    addEventListeners();
                })
                .catch(error => {
                    console.error('Error al cargar comentarios:', error);
                    alert('No se pudieron cargar los comentarios.');
                });
        }

        // 2. Función para adjuntar eventos a los botones (Orden, Limpiar, Filtrar)
        function addEventListeners() {
            
            // A. Event listener para los botones de ORDENAR y LIMPIAR FILTRO (.sort-btn)
            document.querySelectorAll('.sort-btn').forEach(button => {
                button.onclick = function() {
                    let params = {};
                    // Lógica para determinar los parámetros
                    if (this.dataset.order) {
                        // Ordenamiento (mas_nuevo o mas_antiguo)
                        params = { orden: this.dataset.order };
                    } 
                    // Nota: Si es el botón "Limpiar Filtro", params queda vacío, lo que usa el default del servidor.
                    
                    cargarComentarios(params);
                };
            });
            
            // B. Event listener para los botones de FILTRAR por Usuario (.filter-btn)
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.onclick = function() {
                    const autorId = this.dataset.filterUser;
                    
                    // Mantiene el orden actual al aplicar el filtro de usuario
                    // Se busca el botón activo (el que tiene la clase 'is-active')
                    const ordenActual = document.querySelector('.sort-btn.is-active')?.dataset.order || 'mas_nuevo';
                    
                    // Llamada a AJAX con el orden y el filtro de usuario
                    cargarComentarios({ orden: ordenActual, autor_id: autorId });
                };
            });
        }
        
        // 3. Ejecuta la función de listeners al cargar la página por primera vez
        addEventListeners();
    });

</script>
</body>

</html>