{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/style_articulo.css' %}">
{% endblock %}

{% block contenido_principal %}
    <article class="post-detail__article"> 

        <h1 class="post-detail__title">{{ post.titulo }}</h1>
        <span class="post-detail__category">Categoría: {{ post.categoria_post }}</span>

        <div class="post-detail__meta">
            <span class="post-detail__author-meta">
            <i data-lucide="user" class="icon"></i>
            {{ post.autor_post }}
            </span>
            <span class="post-detail__date-meta">
            <i data-lucide="calendar" class="icon"></i>
            {{ post.fecha_creacion|date:"d/m/Y" }}
            </span>
            <span class="post-detail__read-time-meta">
            <i data-lucide="clock" class="icon"></i>
            {{ post.fecha_creacion|naturaltime }}
            </span>
            <span><i data-lucide="message-circle" class="icon"></i>
            {{ post.comentarios.count }} Comentarios
            </span>
        </a>
    </div>

    {% if post.imagen_post %}
    <img src="{{ post.imagen_post.url }}" alt="Imagen {{ post.titulo }}" 
        class="post-detail__image"
        onerror="this.onerror=null;this.src='https://placehold.co/300x200/4CAF50/white?text=SinImagen';">
    {% endif %}

    <div class="post-detail__content">
        <p class="post-detail__lead">{{ post.resumen }}</p>
        {{ post.contenido|safe }}

        {% if post.link_spotifylist %}
        <iframe style="border-radius:12px"
            src=" {{ post.link_spotifylist}}"
            width="100%" height="352" frameBorder="0" allowfullscreen=""
            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
            loading="lazy">
        </iframe>
        {% endif %}

    </div>

    <button data-action="open-comments" class="comments-panel__login-button" style="width: auto; margin-top: 2rem;">
        <i data-lucide="message-square" style="width:1.2rem; height:1.2rem; margin-right:0.5rem; color:white;"></i>
        Ver/Escribir Comentarios
    </button>
</article>

        <div class="comments-panel">
            <div class="comments-panel__header">
                <h4 class="comments-panel__title">
                    <i data-lucide="message-square" style="margin-right:0.5rem;"></i>
                    Comentarios ({{ comentarios.count }})
                </h4>
                <button class="comments-panel__close-button" aria-label="Cerrar panel">
                    <i data-lucide="x"></i>
                </button>
            </div>

    {# --- FORMULARIO DE COMENTARIO --- #}
    {% if user.is_authenticated %}
        
        <p>¡Bienvenido a nuestra sección de comentarios!</p>
        <p>Recuerda revisar nuestras <a href="{% url 'pautas' %}"><strong>Pautas de la comunidad</strong></a> </p>
        
        <form method="post" action="{% url 'detalle_articulo' pk=post.pk %}" class="comments-panel__form">
            {% csrf_token %} 
            
            
            {{ form_comentario.contenido_comentario }} 
            
            {% if form_comentario.contenido_comentario.errors %}
                <p class="comments-panel__error-message">{{ form_comentario.contenido_comentario.errors }}</p>
            {% endif %}
            
            {{ form_comentario.non_field_errors }} 
            
            <button type="submit" class="comments-panel__login-button"
                        style="width: 100%; margin-top: 2rem;">
                        <i data-lucide="message-square"
                            style="width:1.2rem; height:1.2rem; margin-right:0.5rem; color:white;"></i>
                Enviar Comentario
            </button>
        </form>
    
    {% else %}
        <p>Inicia sesión para dejar un comentario.</p>
        <p>Recuerda revisar nuestras <a href="{% url 'pautas' %}"><strong>Pautas de la comunidad</strong></a> </p>
        </p>

        <a href="{% url 'blog_auth:login' %}?next={{ request.path }}" class="comments-panel__login-button">
            Inicia sesión para comentar
        </a>
    
    {% endif %}

    {# --- LISTA DE COMENTARIOS --- #}
    <div class="comments-panel__comment-list" id="contenedor-comentarios">
    {# El ID es lo que JavaScript necesita para saber dónde actualizar el contenido #}
    {% include 'partials/lista_comentarios_fragmento.html' %} 

    </div>
</div>

   <script>
    // Inicializa íconos de Lucide
    lucide.createIcons();

    // --- Lógica del Panel Lateral de Comentarios ---
    const commentsPanel = document.querySelector('.comments-panel');
    const openButtons = document.querySelectorAll('[data-action="open-comments"]');
    const closeButton = document.querySelector('.comments-panel__close-button');


    function openCommentsPanel(event) {
        if (event) {
            event.preventDefault(); // Previene la navegación si fuera un enlace
        }
        commentsPanel.classList.add('comments-panel--open');
    }

    function closeCommentsPanel() {
        commentsPanel.classList.remove('comments-panel--open');
    }

    // Asignar listener a todos los botones de comentarios para abrir el panel
    openButtons.forEach(button => {
        button.addEventListener('click', openCommentsPanel);
    });

    // Asignar listener al botón de cierre
    closeButton.addEventListener('click', closeCommentsPanel);

    // Opcional: Cerrar al presionar la tecla ESC
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && commentsPanel.classList.contains('comments-panel--open')) {
            closeCommentsPanel();
        }
    });

    // --- LÓGICA AJAX PARA ORDENAMIENTO Y FILTRADO ---
    document.addEventListener('DOMContentLoaded', function() {
        // --- Variables de AJAX ---
        const contenedor = document.getElementById('contenedor-comentarios');
        const postPk = '{{ post.pk }}';

        // 1. Función principal para cargar los comentarios vía AJAX (Actualiza el contenido)
        function cargarComentarios(params = {}) {
            // Construye la URL para la vista AJAX
            const url = `/articulo/${postPk}/comentarios-ajax/?${new URLSearchParams(params).toString()}`;
            
            // Indicador de carga temporal
            contenedor.innerHTML = '<p class="text-center p-3">Cargando comentarios...</p>';
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error HTTP: ${response.status}`);
                    }
                    return response.text(); 
                })
                .then(html => {
                    // Reemplaza el contenido del contenedor con el nuevo HTML
                    contenedor.innerHTML = html; 
                    // CRUCIAL: Vuelve a adjuntar los eventos a los botones nuevos
                    addEventListeners();
                })
                .catch(error => {
                    console.error('Error al cargar comentarios:', error);
                    alert('No se pudieron cargar los comentarios.');
                });
        }

        // 2. Función para adjuntar eventos a los botones (Orden, Limpiar, Filtrar)
        function addEventListeners() {
            
            // A. Event listener para los botones de ORDENAR y LIMPIAR FILTRO (.sort-btn)
            document.querySelectorAll('.sort-btn').forEach(button => {
                button.onclick = function() {
                    let params = {};
                    // Lógica para determinar los parámetros
                    if (this.dataset.order) {
                        // Ordenamiento (mas_nuevo o mas_antiguo)
                        params = { orden: this.dataset.order };
                    } 
                    // Nota: Si es el botón "Limpiar Filtro", params queda vacío, lo que usa el default del servidor.
                    
                    cargarComentarios(params);
                };
            });
            
            // B. Event listener para los botones de FILTRAR por Usuario (.filter-btn)
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.onclick = function() {
                    const autorId = this.dataset.filterUser;
                    
                    // Mantiene el orden actual al aplicar el filtro de usuario
                    // Se busca el botón activo (el que tiene la clase 'is-active')
                    const ordenActual = document.querySelector('.sort-btn.is-active')?.dataset.order || 'mas_nuevo';
                    
                    // Llamada a AJAX con el orden y el filtro de usuario
                    cargarComentarios({ orden: ordenActual, autor_id: autorId });
                };
            });
        }
        
        // 3. Ejecuta la función de listeners al cargar la página por primera vez
        addEventListeners();
    });

</script>

{% endblock %}